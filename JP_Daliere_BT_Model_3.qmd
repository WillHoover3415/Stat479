---
title: "BT Model 3 (Accounting for Team Form)"
format: html
editor: visual
---

```{r}
library(tidyverse)
devtools::install_github("hturner/BradleyTerry2")
library(BradleyTerry2)
```

**BT Model #3: Accounting for Team Form:**

The third and final Bradley-Terry Model we built accounts for one additional variable: team form.

**Motivation:**

Over the course of a 162 game season, it is common for players and teams to get hot and cold. Because of this, we wonder if accounting for recent team performance will make our model more accurate.

**Team Form:**

We define team form as a team's win rate over their last 15 games.

Team Form = \# of Wins over last 15 games / 15

**1. Building our BT Model #3:**

First, we load in the dataframe.

```{r}
##Load in the games_with_pitchers df
games_with_pitchers <- read.csv("games_with_pitchers.csv")
```

Next, we perform data manipulation. We derive new columns for at_home (indicator variable which signals whether team was playing at home) and pitcher_ERA (starting pitcher ERA).

```{r}
unik_teams <- sort(unique(c(games_with_pitchers$Home_Tm, games_with_pitchers$Away_Tm)))

results <- games_with_pitchers %>% 
  rename(home_team = Home_Tm, away_team = Away_Tm) %>% 
  mutate(
    home_team = factor(home_team, levels = unik_teams), 
    away_team = factor(away_team,levels = unik_teams),
    home_athome = 1,
    away_athome = 0) %>% 
  select(Date, game_id, home_team, away_team, Home_Winner, Away_Winner, home_athome, away_athome, Home_Pitcher_ERA, Away_Pitcher_ERA)
```

**Create Home Win Probability Function:**

We then define our home win probability function. This will be used to compute theoretical win probabilities for the home team in every regular season game.

It takes six arguments:

1.  home_team
2.  away_team
3.  home_pitcher_ERA
4.  away_pitcher_ERA
5.  home_team_form
6.  away_team_form

It then uses these variables to compute the difference in latent strengths, difference in pitcher ERAs, and difference in team forms, which are plugged into the formula for the probability that team H (the home team) beats team A (the away team) at H's home.

```{r}
##Home Win Prob
Home_Win_Prob <- function(home_team, away_team, home_pitcher_era, 
                          away_pitcher_era, home_team_form, away_team_form) {
  diff_latent_strengths <- 
    lambda_hat[home_team, "ability"] - lambda_hat[away_team, "ability"]
  
  diff_pitcher_eras <- (home_pitcher_era - away_pitcher_era)
  
  diff_team_forms <- (home_team_form - away_team_form)
  
  return(1/(1 + exp(-1 * (diff_latent_strengths + lambda_home + (diff_pitcher_eras*lambda_pitcher_era) + (diff_team_forms * lambda_form)))))
}
```

**Creating Team Form Variable**:

To build our BT model which accounts for team form, we first must derive two new variables: home_team_form and away_team_form.

We derive these team form variables by pivoting our dataframe into a longer format where each row corresponds to a unique team and game. And each row contains information as to whether each team won or lost the game.

We then use this longer dataframe to compute each team's win rate (over their last 15 games). And combine this dataframe (containing team form) with our original dataframe.

```{r}
library(dplyr)
library(tidyr)
library(purrr)

# Ensure Date is a proper Date type and games are in order
results <- results %>%
  mutate(Date = as.Date(Date)) %>%
  arrange(Date)

# Longer format: each row corresponds to a unique game and team combination
results_long <- results %>%
  mutate(Game_ID = row_number()) %>%
  pivot_longer(
    cols = c(home_team, away_team),
    names_to = "Side",
    values_to = "Team"
  ) %>%
  mutate(
    Win = ifelse(Side == "home_team", Home_Winner, Away_Winner)
  ) %>%
  select(Game_ID, Date, Team, Win)

# Compute each team's rolling win rate (over last 15 games)
results_form <- results_long %>%
  group_by(Team) %>%
  arrange(Date) %>%
  mutate(
    team_form = map_dbl(seq_along(Win), function(i) {
      past_games <- Win[max(1, i - 15):(i - 1)]
      if (length(past_games) == 0) return(NA_real_)
      mean(past_games)
    })
  ) %>%
  ungroup()

# Join both home and away team form back into main dataframe
results_form <- results_form %>%
  group_by(Game_ID, Date) %>%
  arrange(Game_ID, Date, row_number()) %>%
  mutate(team_order = row_number()) %>%
  summarise(
    home_team = Team[team_order == 1],
    away_team = Team[team_order == 2],
    home_winner = Win[team_order == 1],
    away_winner = Win[team_order == 2],
    home_team_form = team_form[team_order == 1],
    away_team_form = team_form[team_order == 2],
    .groups = "drop"
  ) %>% 
  rename(game_id = "Game_ID", Home_Winner = "home_winner", Away_Winner = "away_winner")

##Combine with original dataframe
results <- inner_join(results, results_form)
```

**Create Temporary Dataframe to Fit our Model:**

To fit the Bradley-Terry Model, our data needs to be in a particular format. The response variables Home_Winner and Away_Winner (indicator variables which indicate whether the home and away teams won or lost) must be stored in a temporary dataframe first.

Then dataframes for the home and away teams (containing all of the relevant variables) are appended to the original temporary dataframe.

```{r}
##Temp Dataframe
tmp_df <- data.frame(game_id = results$game_id, Home_Winner = results$Home_Winner, Away_Winner = results$Away_Winner)

##Home Dataframe appended to temp Dataframe
tmp_df$home_team <- data.frame(team = results$home_team, at_home = results$home_athome, pitcher_era = results$Home_Pitcher_ERA, form = results$home_team_form)

##Away Dataframe appended to temp Dataframe
tmp_df$away_team <- data.frame(team = results$away_team, at_home = results$away_athome, pitcher_era = results$Away_Pitcher_ERA, form = results$away_team_form)
```

**Fitting BT Model with Team Form:**

Once the temporary dataframe is created, we can now fit a Bradley-Terry model to the data. To fit the Bradley_Terry model, we use the BTm function from the BradleyTerry2 package in R.

```{r}
{r}
fit_form <-
    BTm(
      outcome = cbind(Home_Winner, Away_Winner),  
      player1 = home_team, player2 = away_team,
      formula = ~ team + at_home + pitcher_era + form,
      refcat = "ARI",
      id = "team",
      data = tmp_df)

summary(fit_form)
```

Above, you can see a summary output for our model. Surprisingly, the effect of team form was not statistically significant. We obtained an estimate of approximately 0.077.

**2. Assessing Model Accuracy:**

Before using our model to do downstream analysis, we want to assess how good it is at predicting new data. And we want to compare it to our second Bradley-Terry Model which outperformed the first.

We first defined two intermediate functions for Log-Loss and Brier Score which will be used to assess our model's accuracy.

```{r}
##Brier Score Function
brier <- function(y, phat){
  return(mean( (y - phat)^2 ))
}

##Log-Loss Function
logloss <- function(y, phat){
  
  if(any(phat < 1e-12)) phat[phat < 1e-12] <- 1e-12
  if(any(phat > 1-1e-12)) phat[phat > 1-1e-12] <- 1-1e-12
  return(-1 * mean( y * log(phat) + (1-y) * log(1-phat)))
}
```

We then created 100 random training-test splits (75% training/25% testing) and assessed our modelâ€™s accuracy using brier score and log-loss. As can be seen, the BT Model 3 outperformed the second.

```{r}
n_sims <- 100
n_row = nrow(tmp_df)
n_train <- floor(0.75*n_row)

##Initialize testing log loss vector
test_logloss <- rep(NA, times = n_sims)
test_brier <- rep(NA, times = n_sims)

for(r in 1:n_sims){
  set.seed(479+r)
  train_data <-
    tmp_df |>
    dplyr::slice_sample(n = n_train)
  test_data <-
    results |>
    dplyr::anti_join(y = train_data, by = "game_id") 

  ##Fit model using training data
  fit_form <-
    BTm(
      outcome = cbind(Home_Winner, Away_Winner),  
      player1 = home_team, player2 = away_team,
      formula = ~ team + at_home + pitcher_era + form,
      refcat = "ARI",
      id = "team",
      data = train_data) 
  
  ##Extract Lambdas
  lambda_hat <- BTabilities(fit_form)
  lambda_home <- coef(fit_form)["at_home"]
  lambda_form <- coef(fit_form)["form"]
  lambda_pitcher_era <- coef(fit_form)["pitcher_era"]
  
  
  ##Make predictions on testing data
  test_preds_df <- test_data %>% 
    mutate(home_win_prob = Home_Win_Prob(home_team, away_team, Home_Pitcher_ERA, Away_Pitcher_ERA, home_team_form, away_team_form))
  
  ##Compute log-loss and Brier score and store them in the log-loss and brier score vectors
  test_logloss[r] <-
    logloss(test_preds_df$Home_Winner, test_preds_df$home_win_prob)
  test_brier[r] <-
    brier(test_preds_df$Home_Winner, test_preds_df$home_win_prob)
}

cat("Dist testing logloss:", round(mean(test_logloss), digits = 3), "\n")
cat("Dist testing brier:", round(mean(test_brier), digits = 3), "\n")
```

Our BT Model 3 had a log-loss of approximately 0.517 and a brier score of approximately 0.16. Therefore, we proceed with it to do downstream analysis as it is our most accurate model.

**3. Analysis with BT Model 3**

**Extract Lambda Values:**

We extract the lambdas for the latent team strengths, for home advantage, for team form, and for pitcher ERAs. These lambdas will be plugged into our home_win_prob function to obtain theoretical home win probabilities.

```{r}
lambda_hat <- BTabilities(fit_form)
lambda_home <- coef(fit_form)["at_home"]
lambda_form <- coef(fit_form)["form"]
lambda_pitcher_era <- coef(fit_form)["pitcher_era"]
```

**Create Dataframe with Theoretical Home Win Probabilities:**

We create a new dataframe containing theoretical home win probabilities for each game in the MLB regular season.

```{r}
preds_df <- results %>% 
    mutate(home_win_prob = Home_Win_Prob(home_team, away_team, Home_Pitcher_ERA, Away_Pitcher_ERA, home_team_form, away_team_form))
```

**Distribution of Wins:**

We wish to estimate how often the Dodgers finish with the best record in baseball. To answer this question, it is helpful to visualize the win distribution for each MLB team.

This distribution is an approximation (as it is obtained from just 100 simulations) but it helps us visualize the number of wins each MLB team would earn if we simulated the MLB regular season a large number of times.

It is clear from this visualization that the Dodgers would finish with the best record in Baseball at a very high rate if we simulated the MLB season a large number of times.

```{r}
set.seed(380)
n_sims <- 100

simulations_results <- 
  replicate(n_sims, (preds_df %>% 
                         mutate(
                         random_number = runif(n()),
                         Home_Simulated_Win = ifelse(home_win_prob > random_number, 1, 0),
                         Away_Simulated_Win = 1 - Home_Simulated_Win)
  ), simplify = FALSE)
```

**Simulation Results Grouped into a Single Dataframe**

We wish to estimate the number of times the Dodgers would finish with the best record in baseball. And to do this, we must group the simulation results into a single dataframe.

```{r}
simulation_df = bind_rows(simulations_results, .id = "sim_id")
simulation_df
```

**Simulation Results from all 100 Seasons Grouped into a Single Dataframe**

And then we must group the simulations results from each season into a single dataframe.

```{r}
hundred_season_summary_tmp_1 <- simulation_df %>% 
  group_by(sim_id, home_team) %>% 
  summarize(Home_Wins = sum(Home_Simulated_Win)) %>% 
  rename(team = home_team)

hundred_season_summary_tmp_2 <- simulation_df %>% 
  group_by(sim_id, away_team) %>% 
  summarize(Away_Wins = sum(Away_Simulated_Win)) %>% 
  rename(team = away_team)

hundred_season_summary <- hundred_season_summary_tmp_1 %>% 
  left_join(hundred_season_summary_tmp_2, by = c("team", "sim_id")) %>% 
  mutate(Total_Wins = Home_Wins + Away_Wins, Home_Losses = 81 - Home_Wins, Away_Losses = 81 - Away_Wins, Total_Losses = 162 - Total_Wins)
```

**Summary Statistics for Distribution of Wins**

```{r}
##Team Rankings
team_rankings = hundred_season_summary %>%
  group_by(sim_id) %>% 
  mutate(League_Rank = rank(-Total_Wins, ties.method = "min")) %>%
  ungroup()

##Table with Summary Statistics
team_summary = team_rankings %>% 
  group_by(team) %>% 
  summarize(Average_Rank = mean(League_Rank),
            q25_rank = quantile(League_Rank, 0.25),
            q75_rank = quantile(League_Rank, 0.75),
            Times_1st = sum(League_Rank == 1),
            Times_Top_5 = sum(League_Rank <= 5),
            Times_Top_10 = sum(League_Rank <= 10),
            Average_Wins = mean(Total_Wins),
            q25_wins = quantile(Total_Wins, 0.25),
            q75_wins = quantile(Total_Wins, 0.75),
            Average_Losses = mean(Total_Losses),
            Max_Wins = max(Total_Wins),
            Min_Wins = min(Total_Wins),
            Prob_1st = Times_1st/ n_sims,
            Prob_Top_5 = Times_Top_5 / n_sims,
            Prob_Top_10 = Times_Top_10 / n_sims
)
```

**Set Color Palette**

```{r}
mlb_colors_custom = c(
  "ARI" = "#A71930",
  "ATL" = "#CE1141",
  "BAL" = "#DF4601",
  "BOS" = "#BD3039",
  "CHC" = "#0E3386",
  "CHW" = "#27251F",
  "CIN" = "#C6011F",
  "CLE" = "#E31937",
  "COL" = "#552583",
  "DET" = "#0C2C56",
  "HOU" = "#EB6E1F",
  "KCR" = "#004687",
  "LAA" = "#BA0021",
  "LAD" = "#005A9C",
  "MIA" = "#00A3E0",
  "MIL" = "#12284B",
  "MIN" = "#002B5C",
  "NYM" = "#002D72",
  "NYY" = "#0C2340",
  "OAK" = "#006341",
  "PHI" = "#E81828",
  "PIT" = "#FDB827",
  "SDP" = "#2F241D",
  "SFG" = "#FD5A1E",
  "SEA" = "#0C2C56",
  "STL" = "#C41E3A",
  "TBR" = "#092C5C",
  "TEX" = "#003278",
  "TOR" = "#134A8E",
  "WSN" = "#AB0003",
  "DET" = "#0C2C56"
)
```

```{r}
home_winners = games_with_pitchers %>% group_by(Home_Tm) %>% summarise(Home_Wins = sum(Home_Winner))  %>% ungroup() %>% 
  rename(team = Home_Tm)
away_winners = games_with_pitchers %>% group_by(Away_Tm) %>% summarise(Away_Wins = sum(Away_Winner))  %>% ungroup() %>% 
  rename(team = Away_Tm)
total_winners <- home_winners %>% 
  left_join(away_winners, by = "team") %>% 
  mutate(total_wins = Home_Wins + Away_Wins) %>% 
  select(team, total_wins)
team_summary <- team_summary %>%
  left_join(total_winners, by = "team")
```

**Win Distribution Graph**

```{r}
ggplot(team_summary, aes(x = reorder(team, Average_Wins))) +
  geom_col(aes(y = Average_Wins), fill = "gray7", alpha = 0.6) +
  geom_col(aes(y = total_wins, fill = team), width = 0.5) +
  scale_fill_manual(values = mlb_colors_custom) +
  labs(x = "Team", y = "Wins") +
  ggtitle("Team Win Distribution") +
  theme_minimal() +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5))
```

```{r}
top1 = ggplot(data = team_summary, aes(x = reorder(team, Times_1st), y = Times_1st, fill = team)) + geom_col() + scale_fill_manual(values = mlb_colors_custom) + theme(legend.position = "none") + labs(x = "Team", y = "Times First Place") + labs(x = "Team", y = "First Place Finishes Through 100 Simulations" ) + ggtitle("Number of First Place Finishes through 100 Simulations") + theme_minimal() +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5))
top1
```
