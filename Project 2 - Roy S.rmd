---
title: "Project 2 - Roy Son"
author: "Roy Son"
date: "2025-11-05"
output: html_document
---

```{r}
library(tidyverse)
devtools::install_github("hturner/BradleyTerry2")
library(BradleyTerry2)
```

```{r}
games_with_pitchers <- read.csv("games_with_pitchers.csv")
```

```{r}
unik_teams <- sort(unique(c(games_with_pitchers$Home_Tm, games_with_pitchers$Away_Tm)))
```

```{r}
results <- games_with_pitchers %>% 
  rename(home_team = Home_Tm, away_team = Away_Tm) %>% 
  mutate(
    home_team = factor(home_team, levels = unik_teams), 
    away_team = factor(away_team,levels = unik_teams),
    home_athome = 1,
    away_athome = 0) %>% 
  select(Date, game_id, home_team, away_team, Home_Winner, Away_Winner, home_athome, away_athome, Home_Pitcher_ERA, Away_Pitcher_ERA)
```

```{r}
##Temp Dataframe
tmp_df <- data.frame(Home_Winner = results$Home_Winner, Away_Winner = results$Away_Winner)

tmp_df$home_team <- data.frame(team = results$home_team, at_home = results$home_athome, pitcher_era = results$Home_Pitcher_ERA)

tmp_df$away_team <- data.frame(team = results$away_team, at_home = results$away_athome, pitcher_era = results$Away_Pitcher_ERA)
```

```{r}
summary(tmp_df$away_team["at_home"])


summary(tmp_df$home_team["at_home"])
```

```{r}
##Fitting Model to our Data
fit <-
  BTm(
    outcome = cbind(Home_Winner, Away_Winner),  
    player1 = home_team, player2 = away_team,
    formula = ~ team + at_home + pitcher_era,
    refcat = "BOS",
    id = "team",
    data = tmp_df) 

summary(fit)
```

```{r}
lambda_hat <- BTabilities(fit)
lambda_home <- coef(fit)["at_home"]
```

```{r}
##Home Win Prob
Home_Win_Prob <- function(home_team, away_team, home_pitcher_era, 
                          away_pitcher_era) {
  diff_latent_strengths <- 
    lambda_hat[home_team, "ability"] - lambda_hat[away_team, "ability"]
  
  diff_pitcher_eras <- (home_pitcher_era - away_pitcher_era)
  
  lambda_pitcher_era <- coef(fit)["pitcher_era"]
  
  return(1/(1 + exp(-1 * (diff_latent_strengths + lambda_home + (diff_pitcher_eras*lambda_pitcher_era)))))
}
```

```{r}
brier <- function(y, phat){
  return(mean( (y - phat)^2 ))
}

logloss <- function(y, phat){
  
  if(any(phat < 1e-12)) phat[phat < 1e-12] <- 1e-12
  if(any(phat > 1-1e-12)) phat[phat > 1-1e-12] <- 1-1e-12
  return(-1 * mean( y * log(phat) + (1-y) * log(1-phat)))
}

probs_df <- results %>% 
    mutate(home_win_prob = Home_Win_Prob(home_team, away_team, Home_Pitcher_ERA, Away_Pitcher_ERA))

brier(probs_df$Home_Winner, probs_df$home_win_prob)
logloss(probs_df$Home_Winner, probs_df$home_win_prob)
```


```{r}
set.seed(100)

Simulated_Seasons = 1000

sim_df = probs_df %>%
  select(home_team, away_team, home_win_prob)

prob_home_win = sim_df$home_win_prob
n_games = length(prob_home_win)

outcomes = matrix(
  rbinom(n_games * Simulated_Seasons, size = 1, prob = rep(prob_home_win, Simulated_Seasons)),
  nrow = n_games, ncol = Simulated_Seasons
)

H = model.matrix(~home_team -1, sim_df)
A = model.matrix(~away_team -1, sim_df)
team_names = colnames(H)

Wins = t(H) %*% outcomes + t(A) %*% (1-outcomes)

monte_carlo_expected_wins = tibble(
  Team = team_names,
  Expected_wins = rowMeans(Wins),
  q_2.5 = apply(Wins, 1, quantile, probs = 0.025),
  q_50 = apply(Wins, 1, quantile, probs = 0.50),
  q_97.5 = apply(Wins, 1, quantile, probs = 0.975)
) %>%
  arrange(desc(Expected_wins))

monte_carlo_expected_wins %>% 
  print(n=30)
```

```{r}
ggplot(monte_carlo_expected_wins, aes(x = reorder(Team, Expected_wins), y = Expected_wins))+
  geom_point()+
  geom_errorbar(aes(ymin = q_2.5, ymax = q_97.5), width = 0.25)+
  coord_flip()+
  labs(
    title = "Expected Wins using Monte Carlo",
    x = "Team",
    y = "Expected Wins"
  )+theme_minimal()
```

